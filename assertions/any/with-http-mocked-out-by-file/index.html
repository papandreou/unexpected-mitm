
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
    <link rel="stylesheet" href="../../../static/normalize.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../static/main.css" type="text/css" media="screen" />
    <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../../../static/bug-icon-black.ico">
    <title>any - with http mocked out by file</title>
</head>
<body class="sidebar-hidden has-sidebar"> 
    <header>
        <div class="logo-icon"></div>
        <nav>
            <ul>
                <li class="menu-toggle-item">
                    <button class="menu-toggle" onclick="toggleSidebar()"></button>
                </li>
                
                <li class=""><a href="../../..">unexpected-mitm</a></li>
                
                
                <li class="active"><a href="../with-http-mocked-out">Assertions</a></li>
                
                
                
            </ul>
        </nav>
        <div class="search" style="visibility: hidden">
            <input id="search" placeholder="Search..." value="">
            <div id="searchDropDown" class="dropDown">
                <ul id="searchResults"></ul>
            </div>
        </div>
    </header>

<section id="assertions">
    <nav id="assertion-menu" class="sidebar js-remember-scroll-position">
    
        <h3 class=""><a href="..">any</a></h3>
        <ul>
            
            <li class="">
                <a href="../with-http-mocked-out">with http mocked out</a>
            </li>
            
            <li class="active">
                <a href="">with http mocked out by file</a>
            </li>
            
            <li class="">
                <a href="../with-http-recorded">with http recorded</a>
            </li>
            
        </ul>
    
</nav>

    <div class="main" tabindex="-1">
        <div class="content">
            <h1>with http mocked out by file</h1>
            
                <ul class="declarations">
                
                    <li>&lt;any&gt; with http mocked out by file [and verified] [with extra info] &lt;string&gt; &lt;assertion&gt;</li>
                
                </ul>
            
            <p>Mock out the node.js <code>http</code> or <code>https</code> modules from a file on disk
that contains the same definition syntax as &quot;with http mocked out&quot;.</p>
<p>Below is an example of the assertion syntax used to invoke one of the
file mocks included in the test suite.</p>
<div class="code lang-javascript">
  <div>expect<span style="color: #000000">.</span><span style="color: #000000">installPlugin</span><span style="color: #000000">(</span><span style="color: #000000">require</span><span style="color: #000000">(</span><span style="color: #df5000">'unexpected-http'</span><span style="color: #000000">));</span></div>
  <div>&nbsp;</div>
  <div><span style="color: #000000">it</span><span style="color: #000000">(</span><span style="color: #df5000">'should&nbsp;return&nbsp;a&nbsp;405&nbsp;status&nbsp;code&nbsp;when&nbsp;doing&nbsp;GET&nbsp;/notQuiteYet'</span><span style="color: #000000">,</span>&nbsp;<span style="color: #a71d5d">function</span>&nbsp;<span style="color: #000000">()</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a71d5d">return</span>&nbsp;<span style="color: #000000">expect</span><span style="color: #000000">(</span><span style="color: #df5000">'POST&nbsp;/notQuiteYet'</span><span style="color: #000000">,</span>&nbsp;<span style="color: #df5000">'with&nbsp;http&nbsp;mocked&nbsp;out&nbsp;by&nbsp;file'</span><span style="color: #000000">,</span>&nbsp;<span style="color: #df5000">'../testdata/replay.js'</span><span style="color: #000000">,</span>&nbsp;<span style="color: #df5000">'to&nbsp;yield&nbsp;response'</span><span style="color: #000000">,</span>&nbsp;<span style="color: #0086b3">405</span><span style="color: #000000">);</span></div>
  <div><span style="color: #000000">});</span></div>
</div><p>The contents of the mock file used by the example above is as follows:</p>
<div class="code lang-javascript">
  <div>module<span style="color: #000000">.</span>exports&nbsp;<span style="color: #a71d5d">=</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;request&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;method&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #df5000">&quot;GET&quot;</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #000000">},</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;response&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;statusCode&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #0086b3">405</span><span style="color: #000000">,</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;headers&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;Allow&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #df5000">&quot;GET,&nbsp;HEAD&quot;</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #000000">}</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #000000">}</span></div>
  <div><span style="color: #000000">};</span></div>
</div><h2 id="capturing">Capturing</h2>
<p>One of the first things you may wish to do is create your mocks files
on disk from the http(s) activity of existing code to a file.</p>
<p>For this we allow <code>UNEXPECTED_MITM_WRITE=true</code>
to be specified as an environment variable which will cause execution of the
assertion subject and output requests observed to the specified test file.</p>
<h2 id="replaying">Replaying</h2>
<p>You&#39;ve already seen a basic example of a test file and its invocation. In this
standard mode the the assertion will read the file on disk using any mock(s)
found within it. Test file paths may be written both relative and absolute.</p>
<blockquote>
<p>relative paths are resolved based on the file containing the assertion</p>
</blockquote>
<p>A number of additional features are also supported and are described below.</p>
<h3 id="verification">Verification</h3>
<p>As with &quot;with http mocked out&quot; verification can be requested by including the
&quot;and verified&quot; flag as part of the assertion or used on-demand via the command
line <code>UNEXPECTED_MITM_VERIFY=true</code> environment variable.</p>
<h3 id="custom-expect-s">Custom <code>expect()</code>s</h3>
<p>While written http(s) requests are simple objects, we take advantage of our
javascript mock file format and allow mocks to be defined as functions to
which we pass an instance of Unexpected. This enables the use of custom
assertions when defining request checks including asynchronous comparisons:</p>
<div class="code lang-javascript">
  <div>module<span style="color: #000000">.</span>exports&nbsp;<span style="color: #a71d5d">=</span>&nbsp;<span style="color: #a71d5d">function</span>&nbsp;<span style="color: #000000">(</span>expect<span style="color: #000000">)</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a71d5d">return</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;request&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;body&quot;</span><span style="color: #000000">:</span>&nbsp;expect<span style="color: #000000">.</span><span style="color: #000000">it</span><span style="color: #000000">(</span><span style="color: #df5000">'to&nbsp;end&nbsp;with'</span><span style="color: #000000">,</span>&nbsp;<span style="color: #df5000">'123'</span><span style="color: #000000">)</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #000000">},</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;response&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;statusCode&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #0086b3">405</span><span style="color: #000000">,</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;headers&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #000000">{</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #df5000">&quot;Allow&quot;</span><span style="color: #000000">:</span>&nbsp;<span style="color: #df5000">&quot;GET,&nbsp;HEAD&quot;</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #000000">}</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #000000">}</span></div>
  <div>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #000000">};</span></div>
  <div><span style="color: #000000">};</span></div>
</div>
        </div>
    </div>
</section>
<script type="text/javascript">
    baseUrl = '../../..';
</script>
<script type="text/javascript" src="../../../static/toggleSidebar.js"></script>
<script type="text/javascript" src="../../../static/rememberScrollPosition.js"></script>
<script type="text/javascript" src="../../../static/focusMain.js"></script>
<script type="text/javascript" src="../../../static/search.js"></script>
</body>
</html>

